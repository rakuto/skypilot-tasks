name: gptq

resources:
  cloud: aws
  region: us-west-2
  disk_size: 300
  accelerators: A100:8
  use_spot: true
  image_id: ami-08960a7e42546e130 # Deep Learning OSS Nvidia Driver AMI GPU PyTorch 2.2.0 (Ubuntu 20.04) 20240517

workdir: .

setup: |
  set -e
  
  sudo apt-get update
  sudo apt-get install unzip
  if ! command -v aws &> /dev/null
  then
    curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
    unzip awscliv2.zip 
    sudo ./aws/install
    rm -rf aws awscliv2.zip
  fi
 
  echo "Install pip dependencies"
  conda init
  conda activate pytorch
  pip3 install boto3 auto-gptq accelerate transformers optimum
  
  if [[ -z "${HF_TOKEN}" ]]; then
    echo "Log in Hugging Face"
    huggingface-cli login --token "${HF_TOKEN}"
  fi

run: |
  set -e
  
  conda activate pytorch
  python3 gptq.py
